# Web06 - Threads 101

## 上节拾遗
小蒲上节问关于flup的fcgi原理，我阅读了源码，回复在这里: [`https://github.com/tomsheep/dandelion/pull/6#discussion_r21534970`](https://github.com/tomsheep/dandelion/pull/6#discussion_r21534970)

## 线程初步
我们通常说的线程，指的是用户线程（区别于系统线程，在不同的实现中，它和系统可以是一对一、多对一、多对多的关系，回忆一下OS课），而用户线程有多种机制和标准，应用最广泛的恐怕是POSIX线程标准了，它定义了创建和操纵线程的一套API，是`*nix`系统最常用的线程API。Python标准的threading API以及Java的线程API和POSIX十分相近，可以举一反三。

线程是操作系统能够调度的最小单位，一个进程中可以包含多个线程。每个进程是一个隔离容器，有自己的虚拟内存空间（继续回忆OS课），A进程中的变量不能被B进程看到，进程间的通讯需要特殊的通讯手段（共享内存、socket、PIPE等）。而同一进程内的多个线程是共享同一个虚拟地址空间的，也就是说，A线程设置的变量B线程是一览无余的。这样，线程间的通讯就完全可以通过共享变量（也就是直接访问内存）来进行了。这样当然便利，不过也带来了一些复杂性，因为多个线程同时对一个变量进行操作，可能会造成竞争状态（racing），最经典的例子就是取钱了：取钱这个操作被翻译成三条指令(我们假设账户钱足够)

1. 把余额load到寄存器: `reg = a`
2. 把寄存器减去取钱数额: `reg -= n`
3. 把寄存器现在的值写回内存，也就是变量a: `a = reg`

假设有两个线程A和B同时运行这段代码，即便我们就假设只有一个CPU，线程在运行过程中也是可能发生上下文切换的，试想，存在这样一种执行顺序：`A1 -> B1 -> A2 -> B2 -> A3 -> B3`，这样一来，是不是钱被取了两次，但账户只扣了一次钱？所以，对共享变量（多线程可访问）的写，通常需要进行同步操作（最常见最暴力的就是加锁），用同步机制——我们就说锁吧，来保护起来的这段程序block，就叫做`critical section`，加了锁的取钱操作，限定了执行顺序呢只能是`A1 -> A2 -> A3 -> B1 -> B2 ->
B3`或者`B1 -> B2 -> B3 -> A1 -> A2 -> A3`。在多线程环境中可以安全运行，不会出现racing的代码块，我们就称作线程安全的。

## 辅助阅读
由于老师这周工作较多，所以暂时不能准备详细的教程以及lab，我们这节课就算是预热加复习大学内容，老师年轻的时候（现在也很年轻），曾经写过一个Java线程的系列文章，正好，我们这节课的任务就是，阅读这几篇文章，对其中讨论的问题做些理解与思考。虽然这几篇文章针对的是JVM的线程API（以及内存模型），不过不同平台的线程原理是很相近的，理解了之后对CPython的threading API，乃至pthreads都会触类旁通。

+ [Java Concurrency(1) Java内存模型](http://blog.tomsheep.net/2010/06/08/java-concurrency-jmm/)
+ [Java Concurrency(2) Monitor](http://blog.tomsheep.net/2010/06/09/java-concurrency-monitor/)
+ [Java Concurrency(3) 可见性重访之锁、Volatile与原子变量](http://blog.tomsheep.net/2010/06/10/java-concurrency-visibility/)
+ [Java Concurrency(4) Singleton](http://blog.tomsheep.net/2010/06/13/java-concurrency-singleton/)

其中第二篇讲述的Monitor是Java独有的机制，不过聪明的小蒲肯定能透过现象看穿本质~ 第四篇有些奇技淫巧，重在领会一些`同步`的根本的概念。所以我个人觉得第一、三篇是比较切中要害的：多线程编程关心的无非就是`同步`二字，为什么要同步，无非是因为`共享`二字（如果没有共享，那么再多线程也不打紧，让它们欢快地去跑就是了，肯定是线程安全的）。而为了实现同步所关心的，有两个方面，一个是`互斥`(critical section保证的就是互斥),
一个是`可见性`(这个不如互斥性好理解，理解了很有帮助，不是很理解也不妨碍对多线程编程的掌握)

我们在后面的课程依然是以Python作为教学平台的，下一节会给出对应lab。

## Homework
1. 简述线程和进程的关系，以及区别。
2. 举例说明哪些场景使用多线程会带来好处
3. 在你举的例子中，指出哪里是需要`同步`的（或者这个例子不需要同步）
4. 回忆OS课，简述锁、信号量、条件变量这几个同步原语（原语，英文primitive, 当`基础功能`理解）的原理，并说明他们分别适用于哪些场景。
5. 提出问题


